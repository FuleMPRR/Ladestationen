<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EV‑Ladestationen – Übersicht</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <style>
    body { margin:0; font-family:sans-serif; background:#0b0f19; color:#e6e9ee; }
    header { padding:1rem; border-bottom:1px solid #1f2a44; }
    .controls { display:flex; gap:.5rem; padding:1rem; }
    #map { height:500px; margin:1rem; border-radius:12px; border:1px solid #1f2a44; }
    table { width:calc(100% - 2rem); margin:1rem; border-collapse:collapse; background:#121829; }
    th,td { padding:.5rem; border:1px solid #1f2a44; }
  </style>
</head>
<body>
  <header>
    <h1>EV‑Ladestationen</h1>
    <p>GitHub‑Seite mit Karte, Suche und Standort</p>
  </header>
  <div class="controls">
    <input id="q" type="search" placeholder="Suche…" />
    <button id="exportCsv">CSV exportieren</button>
    <button id="locate">Mein Standort ▶︎ Nächste</button>
    <button id="reset">Zurücksetzen</button>
  </div>
  <div id="map"></div>
  <table>
    <thead><tr><th>Name</th><th>Lat</th><th>Lon</th></tr></thead>
    <tbody id="rows"></tbody>
  </table>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const DEFAULT_VIEW = { center:[46.8182,8.2275], zoom:7 };
    let stations=[], map, markersLayer, youMarker, nearestLine;

    function haversine(lat1, lon1, lat2, lon2){
      const R=6371000, toRad=d=>d*Math.PI/180;
      const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
      const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }

    function parseRow(r){
      let name=r.Name||"", lat,lon;
      if(r.Lat&&r.Lon){ lat=parseFloat(r.Lat); lon=parseFloat(r.Lon); }
      else if(r.Koordinaten){ const p=r.Koordinaten.split(','); lon=parseFloat(p[0]); lat=parseFloat(p[1]); }
      if(!isFinite(lat)||!isFinite(lon)) return null;
      return {name,lat,lon};
    }

    async function loadCSV(){
      const res=await fetch('Google_Maps_Liste.csv');
      const text=await res.text();
      const parsed=Papa.parse(text,{header:true,skipEmptyLines:true});
      return parsed.data.map(parseRow).filter(Boolean);
    }

    function initMap(){
      map=L.map('map');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);
      markersLayer=L.layerGroup().addTo(map);
      map.setView(DEFAULT_VIEW.center,DEFAULT_VIEW.zoom);
    }

    function render(list){
      document.getElementById('rows').innerHTML=list.map(s=>`<tr><td>${s.name}</td><td>${s.lat.toFixed(5)}</td><td>${s.lon.toFixed(5)}</td></tr>`).join('');
      markersLayer.clearLayers();
      list.forEach(s=>L.marker([s.lat,s.lon]).addTo(markersLayer).bindPopup(`<b>${s.name}</b>`));
      if(list.length) map.fitBounds(list.map(s=>[s.lat,s.lon]));
    }

    function filter(){
      const t=document.getElementById('q').value.toLowerCase();
      const f=stations.filter(s=>s.name.toLowerCase().includes(t));
      render(f);
    }

    function locateAndFindNearest(){
      if(!navigator.geolocation) return alert('Geolocation nicht verfügbar');
      navigator.geolocation.getCurrentPosition(pos=>{
        const {latitude,longitude}=pos.coords;
        if(youMarker) map.removeLayer(youMarker);
        if(nearestLine) map.removeLayer(nearestLine);
        youMarker=L.circleMarker([latitude,longitude],{radius:8,color:'red'}).addTo(map).bindPopup('Du bist hier');
        let best=null,dist=1e9;
        for(const s of stations){ const d=haversine(latitude,longitude,s.lat,s.lon); if(d<dist){dist=d;best=s;} }
        if(best){
          nearestLine=L.polyline([[latitude,longitude],[best.lat,best.lon]],{color:'yellow'}).addTo(map);
          map.fitBounds([[latitude,longitude],[best.lat,best.lon]]);
          L.popup().setLatLng([best.lat,best.lon]).setContent(`<b>${best.name}</b><br>${(dist/1000).toFixed(2)} km`).openOn(map);
        }
      });
    }

    document.addEventListener('DOMContentLoaded',async()=>{
      initMap();
      stations=await loadCSV();
      render(stations);
      document.getElementById('q').addEventListener('input',filter);
      document.getElementById('reset').addEventListener('click',()=>{document.getElementById('q').value='';filter();});
      document.getElementById('exportCsv').addEventListener('click',()=>{
        const header=['Name','Lat','Lon'];
        const csv=[header.join(','),...stations.map(s=>`${s.name},${s.lat},${s.lon}`)].join('\n');
        const blob=new Blob([csv],{type:'text/csv'});
        const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='ladestationen.csv';a.click();
      });
      document.getElementById('locate').addEventListener('click',locateAndFindNearest);
    });
  </script>
</body>
</html>
