<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Ladestationen‑Karte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: #0b0f19; color: #f0f0f0; }
    #map { height: 85vh; width: 100%; }
    #searchbar { padding: 12px; background: #121829; border-bottom: 1px solid #1f2a44; display:flex; }
    #searchInput { flex:1; padding: 12px; font-size: 16px; border-radius: 10px; border:1px solid #1f2a44; background:#0b0f19; color:#e6e9ee; }
    #locateBtn { position: absolute; top: 100px; right: 20px; z-index: 1000; background: #005AE0; color:white; padding: 12px 16px; border: none; border-radius: 10px; cursor: pointer; font-weight:600; box-shadow: 0 4px 12px rgba(0,0,0,0.4); transition: background 0.2s; }
    #locateBtn:hover { background:#003b95; }
    #langSelect { position: absolute; top: 20px; right: 20px; z-index: 1000; display:flex; gap:6px; }
    #langSelect button { background:#121829; border:1px solid #1f2a44; border-radius:8px; padding:6px 8px; cursor:pointer; color:#e6e9ee; }
    .leaflet-popup-content-wrapper { background:#121829; color:#f0f0f0; border-radius:12px; }
    .leaflet-popup-tip { background:#121829; }
    a { color:#4ea3ff; text-decoration:none; }
  </style>
</head>
<body>

<div id="langSelect">
  <button onclick="setLanguage('de')">🇩🇪</button>
  <button onclick="setLanguage('fr')">🇫🇷</button>
  <button onclick="setLanguage('it')">🇮🇹</button>
</div>

<div id="searchbar">
  <input type="text" id="searchInput" placeholder="Suche..." />
</div>

<div id="map"></div>

<div id="locateBtn">📍 Mein Standort</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
const translations = {
  de: { title: "Ladestationen‑Karte", searchPlaceholder: "Suche nach Name oder Ort...", locateBtn: "📍 Mein Standort", routeLink: "📍 Route mit Google Maps", userLocation: "📍 Dein Standort", address: "Adresse" },
  fr: { title: "Carte des bornes de recharge", searchPlaceholder: "Rechercher par nom ou lieu...", locateBtn: "📍 Ma position", routeLink: "📍 Itinéraire avec Google Maps", userLocation: "📍 Votre position", address: "Adresse" },
  it: { title: "Mappa delle colonnine", searchPlaceholder: "Cerca per nome o luogo...", locateBtn: "📍 La mia posizione", routeLink: "📍 Percorso con Google Maps", userLocation: "📍 La tua posizione", address: "Indirizzo" }
};
let currentLang = 'de';
function setLanguage(lang){ currentLang=lang; document.getElementById('searchInput').placeholder=translations[lang].searchPlaceholder; document.getElementById('locateBtn').innerText=translations[lang].locateBtn; document.title=translations[lang].title; updatePopups(); }

let map=L.map('map').setView([46.8,8.3],8);
L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
  maxZoom:20,
  attribution:'Tiles © Esri, Sources: Esri, Maxar, Earthstar Geographics, GIS User Community'
}).addTo(map);
L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}',{
  maxZoom:20,
  attribution:'Labels © Esri',
  opacity:0.9
}).addTo(map);
L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}',{
  maxZoom:20,
  attribution:'Roads © Esri',
  opacity:0.9
}).addTo(map);

let allMarkers=[], userMarker=null, routeLine=null;

async function loadCSV(){
  const res=await fetch('Google_Maps_Liste.csv', { cache: 'no-store' });
  let text=await res.text();
  const parsed=Papa.parse(text,{header:true,skipEmptyLines:true,delimiter:';'});
  const items=[];
  for(const raw of parsed.data){
    const row={};
    Object.keys(raw||{}).forEach(k=>{ if(!k) return; row[k.trim().toLowerCase()]=String(raw[k]??'').trim(); });
    const name=row['name']||'';
    const adresse=row['adresse']||'';
    const plzOrt=row['plz &ort']||row['plz & ort']||row['plz&ort']||'';
    const coordRaw=row['koordinaten n/e']||row['koordinaten n-e']||row['koordinaten']||'';
    const parts=coordRaw.split(/[\s,]+/).filter(Boolean);
    if(parts.length<2) continue;
    const lat=parseFloat(parts[0].replace(',','.'));
    const lng=parseFloat(parts[1].replace(',','.'));
    if(!isFinite(lat)||!isFinite(lng)) continue;
    items.push({name,adresse,plzOrt,lat,lng});
  }
  return items;
}

function buildMarkers(data){
  allMarkers.forEach(m=>map.removeLayer(m));
  allMarkers=[];
  data.forEach(item=>{
    const marker=L.marker([item.lat,item.lng]).addTo(map);
    marker._data=item; allMarkers.push(marker);
  });
  updatePopups();
  if(allMarkers.length){
    const bounds=L.latLngBounds(allMarkers.map(m=>m.getLatLng()));
    map.fitBounds(bounds.pad(0.2));
  }
}

function updatePopups(){
  allMarkers.forEach(marker=>{
    const p=marker._data;
    const popupText=`<strong>${p.name}</strong><br>${translations[currentLang].address}: ${p.adresse}, ${p.plzOrt}<br><br><a href="https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lng}" target="_blank">${translations[currentLang].routeLink}</a>`;
    marker.bindPopup(popupText);
  });
}

function getDistance(lat1,lon1,lat2,lon2){ const R=6371; const toRad=x=>x*Math.PI/180; const dLat=toRad(lat2-lat1),dLon=toRad(lon2-lon1); const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2; return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); }

document.getElementById('searchInput').addEventListener('input',e=>{
  const query=e.target.value.toLowerCase();
  allMarkers.forEach(marker=>{
    const {name,adresse,plzOrt}=marker._data;
    const match=(name||'').toLowerCase().includes(query)||(adresse||'').toLowerCase().includes(query)||(plzOrt||'').toLowerCase().includes(query);
    if(match){ if(!map.hasLayer(marker)) map.addLayer(marker); }
    else{ if(map.hasLayer(marker)) map.removeLayer(marker); }
  });
});

document.getElementById('locateBtn').addEventListener('click',()=>{
  if(!navigator.geolocation){ alert("GPS wird von deinem Gerät nicht unterstützt."); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude,longitude}=pos.coords;
    if(userMarker) map.removeLayer(userMarker);
    if(routeLine) map.removeLayer(routeLine);
    const redIcon=new L.Icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",shadowUrl:"https://unpkg.com/leaflet@1.9.3/dist/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});
    userMarker=L.marker([latitude,longitude],{icon:redIcon}).addTo(map).bindPopup(translations[currentLang].userLocation).openPopup();
    map.setView([latitude,longitude],14);
    let nearestMarker=null,minDist=Infinity;
    allMarkers.forEach(marker=>{ const d=getDistance(latitude,longitude,marker._latlng.lat,marker._latlng.lng); if(d<minDist){minDist=d;nearestMarker=marker;} });
    if(nearestMarker){ nearestMarker.openPopup(); map.panTo(nearestMarker.getLatLng()); routeLine=L.polyline([[latitude,longitude],[nearestMarker.getLatLng().lat,nearestMarker.getLatLng().lng]],{color:'cyan',weight:4,dashArray:'5, 10'}).addTo(map); }
  },()=>{ alert("Standort konnte nicht ermittelt werden."); });
});

(async function init(){ const data=await loadCSV(); buildMarkers(data); setLanguage(currentLang); })();
</script>
</body>
</html>
